
<!DOCTYPE html>
<html>
<head>
	<meta charset=utf-8 />
	<title>Store Locator</title>
	<%= stylesheet_link_tag    'application', media: 'all', 'data-turbolinks-track' => true %>
	<%= javascript_include_tag 'application', 'data-turbolinks-track' => true %>
	<link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700' rel='stylesheet'>
	<script src='https://api.tiles.mapbox.com/mapbox.js/v2.1.4/mapbox.js'></script>
	<link href='https://api.tiles.mapbox.com/mapbox.js/v2.1.4/mapbox.css' rel='stylesheet' />
	<%= csrf_meta_tags %>

</head>

<body>
	<div class='sidebar'>
		<div class='heading'>
			<h1>Our locations</h1>
		</div>
		<div id='listings' class='listings'></div>
	</div>
	<div id='map' class='map'> </div>


<script>
	L.mapbox.accessToken = 'pk.eyJ1IjoidHNjaGFlZmZlcjc1MDQiLCJhIjoibGtEVEpDTSJ9.Ii90udJG3hfV3ftGYafKLQ';
	var geojson = []; 

	<% @restaurants.each do |restaurant| %>
	geojson.push({
		id:  <%=restaurant.id %>,
		type: 'Feature',
		geometry: {
			type: 'Point',
			coordinates: [<%=restaurant.longitude.to_f%>,<%= restaurant.latitude.to_f %>]
		},
		properties: {
			title: '<%= restaurant.name %>',
			description: '<%= restaurant.address %>',
			'marker-color': '#000',
			'marker-symbol': 'star-stroked',
		}
	});
	<% end %>


	var map = L.mapbox.map('map', 'tschaeffer7504.mbaooln6').setView([38.899, -77.015], 12);

	map.scrollWheelZoom.disable();

	var listings = document.getElementById('listings');
	var locations = L.mapbox.featureLayer().addTo(map);

	locations.setGeoJSON(geojson);

	function setActive(el) {
		var siblings = listings.getElementsByTagName('div');
		for (var i = 0; i < siblings.length; i++) {
			siblings[i].className = siblings[i].className
			.replace(/active/, '').replace(/\s\s*$/, '');
		}

		el.className += ' active';
	}

	locations.eachLayer(function(locale) {

    // Shorten locationsocale.feature.properties to just `prop` so we're not
    // writing this long form over and over again.
    var prop = locale.feature.properties;

    // Each marker on the map.
    var popup = '<h3>' + prop.title + '</h3><div>' + prop.description;

    var listing = listings.appendChild(document.createElement('div'));
    listing.className = 'item';

    var link = listing.appendChild(document.createElement('a'));
    link.href = '#';
    link.className = 'title';

    link.innerHTML = prop.title;
    if (prop.crossStreet) {
    	link.innerHTML += '<br /><small class="quiet">' + prop.crossStreet + '</small>';
    	popup += '<br /><small class="quiet">' + prop.crossStreet + '</small>';
    }

    var details = listing.appendChild(document.createElement('div'));
    details.innerHTML = prop.description;
    if (prop.phone) {
    	details.innerHTML += ' &middot; ' + prop.phoneFormatted;
    }

    link.onclick = function() {
    	setActive(listing);

      // When a menu item is clicked, animate the map to center
      // its associated locale and open its popup.
      map.setView(locale.getLatLng(), 16);
      locale.openPopup();
      return false;
  };

    // Marker interaction
    locale.on('click', function(e) {
      // 1. center the map on the selected marker.
      map.panTo(locale.getLatLng());

      // 2. Set active the markers associated listing.
      setActive(listing);
  });

    popup += '</div>';
    locale.bindPopup(popup);

});

</script>
</body>

</html>
